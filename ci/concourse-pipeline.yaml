jobs:
  - name: test-dev
    public: true
    plan:
      - get: src-dev
        trigger: true

      - get: src-ci

      - task: run-tests
        input_mapping:
          src: src-dev
        file: src-ci/ci/tasks/test.yaml

  - name: deploy-dev
    public: true
    serial: true
    plan:
      - get: src-dev
        passed: [test-dev]

      - get: src-ci

      - task: ns-dev
        params:
          ns_key: ((ns_key))
          ns_domain: ((ns_domain))
          dest_dir: "demo.a2s.ninja/dev.demo.a2s.ninja/"
        input_mapping:
          src: src-dev
        file: src-ci/ci/tasks/deploy.yaml

  - name: test-qa
    public: true
    plan:
      - get: src-qa
        trigger: true

      - get: src-ci

      - task: run-tests
        input_mapping:
          src: src-qa
        file: src-ci/ci/tasks/test.yaml

  - name: deploy-qa
    public: true
    serial: true
    plan:
      - get: src-qa
        passed: [test-qa]

      - get: src-ci

      - task: ns-qa
        params:
          ns_key: ((ns_key))
          ns_domain: ((ns_domain))
          dest_dir: "demo.a2s.ninja/qa.demo.a2s.ninja/"
        input_mapping:
          src: src-qa
        file: src-ci/ci/tasks/deploy.yaml

  - name: test-prod
    public: true
    plan:
      - get: src-prod
        trigger: true

      - get: src-ci

      - task: run-tests
        input_mapping:
          src: src-prod
        file: src-ci/ci/tasks/test.yaml


  - name: deploy-prod
    public: true
    serial: true
    plan:
      - get: src-prod
        passed: [test-prod]

      - get: src-ci

      - task: ns-prod
        params:
          ns_key: ((ns_key))
          ns_domain: ((ns_domain))
          dest_dir: "demo.a2s.ninja/prod.demo.a2s.ninja/"
        input_mapping:
          src: src-prod
        file: src-ci/ci/tasks/deploy.yaml

resources:
  - name: src-dev
    public: true
    type: git
    source:
      uri: git@github.com:ynohat/akamai-demo-site.git
      branch: dev
      private_key: ((github-deploy-key))

  - name: src-qa
    public: true
    type: git
    source:
      uri: git@github.com:ynohat/akamai-demo-site.git
      branch: qa
      private_key: ((github-deploy-key))

  - name: src-prod
    public: true
    type: git
    source:
      uri: git@github.com:ynohat/akamai-demo-site.git
      branch: qa
      private_key: ((github-deploy-key))

  - name: src-ci
    public: true
    type: git
    source:
      uri: git@github.com:ynohat/akamai-demo-site.git
      branch: master
      private_key: ((github-deploy-key))
